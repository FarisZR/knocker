{
	# Disable the admin API for security in this simple setup
	admin off
}

:80 {
	# Route requests to different handlers based on the path
	route {
		# Handle the knock request by forwarding it directly to the knocker service.
		@knock path /knock
		handle @knock {
			reverse_proxy knocker:8000 {
				# Trust the proxy network to preserve the original X-Forwarded-For
				trusted_proxies 172.29.238.0/24 fd00:dead:c0de::/64
			}
		}

		# Handle health check requests
		@health path /health
		handle @health {
			reverse_proxy knocker:8000
		}

		# For any other path, first attempt to authenticate.
		handle {
			# Use forward_auth to send a verification request to the knocker service.
			# Caddy will copy the original request's method and headers.
			forward_auth knocker:8000 {
				uri /verify?
				copy_headers X-Forwarded-For X-Forwarded-Proto X-Forwarded-Host
				trusted_proxies 172.29.238.0/24 fd00:dead:c0de::/64
			}

			# If authentication is successful (knocker returns 2xx),
			# proxy the request to the actual backend service.
			# For this demo, we'll just respond with a success message.
			# In a real-world scenario, this would be your application.
			respond "You have accessed the private area!" 200
		}
	}
}
