# Project Architecture Rules (Non-Obvious Only)

- **Stateless Application**: The `knocker` service is designed to be completely stateless. All state is managed in the `whitelist.json` file, which is persisted via a Docker volume. Do not introduce in-memory state that would break this pattern.
- **Reverse Proxy is Essential**: The application is not designed to be exposed directly to the internet. It relies on a reverse proxy (like Caddy) to handle TLS and to provide the `X-Forwarded-For` header, which is critical for the IP whitelisting logic.
- **Configuration via Environment Variable**: The application's configuration is loaded from a single YAML file whose path is specified by the `KNOCKER_CONFIG_PATH` environment variable. This is a deliberate design choice to decouple the configuration from the application code.
- **No Database**: The project intentionally uses a simple JSON file for the whitelist to keep the architecture simple and to avoid introducing a database dependency. Any proposal to add a database would be a major architectural change.

- **Firewalld integration caveat**: When integrating with firewalld, command-line tools (firewall-cmd) may return "success" with a warning (e.g., ALREADY_ENABLED) while not updating timeouts. Any code that adds rich-rules must detect these warnings, remove the existing rule and re-add it with the intended timeout to ensure TTL semantics are enforced.
- **Integration tests are authoritative**: Integration tests (dev/firewalld_integration_test.sh and dev/docker-compose.yml) exercise real interactions with the system (firewalld, Caddy). Use them as the final verification step for changes that touch networking, firewall rules, or startup/restore logic.